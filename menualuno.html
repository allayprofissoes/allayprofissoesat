<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Aluno - Allay Profissões</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Commissioner:wght@100..900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style_simplified_with_menu_updated.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Navigation Menu Lateral -->
    <nav class="nav-menu" id="nav-menu">
        <div class="nav-menu-header">
            <div class="nav-menu-logo">
                <i class="fas fa-bars"></i>
                <span class="nav-menu-title">Menu</span>
            </div>
            <button class="nav-menu-toggle" id="nav-menu-toggle">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="nav-menu-content">
            <ul class="nav-menu-list">
                <li class="nav-menu-item active" data-tab="inicio">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Sala de Aula</span>
                    </a>
                </li>
                 <!-- <li class="nav-menu-item" data-tab="cursos">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-file-pdf"></i>
                        <span>Apostilas</span>
                        <span class="coming-soon-badge">Em Breve</span>
                    ADICIONAR DEPOIS </a>-->
                </li>
                <li class="nav-menu-item" data-tab="progresso">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-handshake"></i>
                        <span>Afiliação</span>
                        <span class="coming-soon-badge">Em Breve</span>
                    </a>
                </li>
                <li class="nav-menu-item" data-tab="certificados">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-certificate"></i>
                        <span>Certificados</span>
                    </a>
                </li>
                <li class="nav-menu-item" data-tab="cronograma">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-bell"></i>
                        <span>Notificações</span>
                        <span id="notification-bell" class="notification-bell" style="display: none;">
                            <i class="fas fa-circle"></i>
                        </span>
                    </a>
                </li>
                <li class="nav-menu-item" data-tab="suporte">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-comments"></i>
                        <span>Suporte</span>
                    </a>
                </li>
                <li class="nav-menu-item" data-tab="politica-privacidade">
                    <a href="#" class="nav-menu-link">
                        <i class="fas fa-shield-alt"></i>
                        <span>Políticas e Privacidade</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="nav-menu-footer">
            <div class="nav-menu-user">
                <div class="nav-menu-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="nav-menu-user-info">
                    <span class="nav-menu-user-name" id="nav-menu-user-name">Usuário</span>
                    <span class="nav-menu-user-role">Aluno</span>
                </div>
            </div>
            
            <button class="nav-menu-logout" id="logout-button">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </button>
        </div>
    </nav>

    <!-- Menu Toggle Button -->
    <button class="nav-menu-btn" id="nav-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay -->
    <div class="nav-menu-overlay" id="nav-menu-overlay"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-container-centered">
                <img src="LuanHenrique(2).png" alt="Logo Allay Profissões" class="logo-centered">
                <div class="welcome-info">
                    <span class="welcome-text" id="welcome-text"></span>   
                </div>
            </div>

        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tab Content: Início -->
        <div class="tab-content active" id="tab-inicio">
            <!-- Sidebar - Meus Cursos -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Meus Cursos</span>
                    </h2>
                </div>
                
                <div class="courses-container">
                    <div class="courses-list" id="courses-list">
                        <!-- Loading state -->
                        <div class="loading-courses" id="loading-courses">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <p>Carregando cursos...</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content" id="main-content">
                <!-- Welcome State (Initial) -->
                <div class="welcome-state" id="welcome-state">
                    <div class="welcome-card">
                        <div class="welcome-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="welcome-title">Bem-vindo à sua Sala de Aula Virtual!</h2>
                        <p class="welcome-description">
                            Selecione um curso na barra lateral para começar a sua jornada de aprendizagem.
                            Aqui você encontrará todos os módulos, vídeos e recursos organizados para o seu sucesso.
                        </p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <i class="fas fa-play-circle"></i>
                                <span>Vídeos Interativos</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-book-open"></i>
                                <span>Módulos Organizados</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-chart-line"></i>
                                <span>Aprendizagem Eficaz</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loading-state" style="display: none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <p>Preparando sua sala de aula...</p>
                </div>

                <!-- Classroom State (After selecting a course) -->
                <div class="classroom-state" id="classroom-state" style="display: none;">
                    <!-- Course Header -->
                    <div class="course-header">
                        <div class="course-info">
                            <h1 class="course-title" id="current-course-title">
                                <i class="fas fa-book"></i>
                                <span>Nome do Curso</span>
                            </h1>
                            <p class="course-description" id="current-course-description">Descrição do curso</p>
                        </div>
                        <div class="course-actions">
                            <button class="btn-secondary" id="back-to-courses">
                                <i class="fas fa-arrow-left"></i>
                                <span>Voltar aos Cursos</span>
                            </button>
                        </div>
                    </div>

                    <!-- Digital Board (Video Player Area) -->
                    <div class="digital-board" id="digital-board" style="display: none;">
                        <div class="board-header">
                            <div class="board-info">
                                <h3 class="video-title" id="video-title-display">Título do Vídeo</h3>
                                <p class="video-module" id="video-module-display">Módulo: Nome do Módulo</p>
                            </div>
                            <div class="board-controls">
                                <button class="board-btn" id="fullscreen-btn" title="Tela Cheia">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="video-container">
                            <div id="player" class="video-player"></div>
                        </div>
                        
                        <div class="video-navigation">
                            <button class="nav-btn nav-prev" id="prev-video-btn">
                                <i class="fas fa-step-backward"></i>
                                <span>Anterior</span>
                            </button>
                            <div class="video-info">
                                <span class="video-counter" id="video-counter">Vídeo 1 de 5</span>
                            </div>
                            <button class="nav-btn nav-next" id="next-video-btn">
                                <span>Próximo</span>
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Course Materials (Modules and Videos) -->
                    <div class="course-materials">
                        <div class="materials-header">
                            <h3 class="materials-title">
                                <i class="fas fa-folder-open"></i>
                                <span>Material do Curso</span>
                            </h3>
                        </div>
                        
                        <div class="modules-container" id="modules-container">
                            <!-- Modules will be dynamically loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Quiz State -->
                <div class="quiz-state" id="quiz-state" style="display: none;">
                    <div class="quiz-container">
                        <div class="quiz-header">
                            <div class="quiz-info">
                                <h2 class="quiz-title" id="quiz-title">Prova do Módulo</h2>
                                <p class="quiz-description" id="quiz-description">Responda todas as questões para concluir o módulo</p>
                            </div>
                            <div class="quiz-progress">
                                <span class="quiz-progress-text" id="quiz-progress-text">Questão 1 de 5</span>
                                <div class="quiz-progress-bar">
                                    <div class="quiz-progress-fill" id="quiz-progress-fill" style="width: 20%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="quiz-content">
                            <div class="question-container" id="question-container">
                                <!-- Questions will be loaded here -->
                            </div>

                            <div class="quiz-navigation">
                                <button class="quiz-btn quiz-btn-secondary" id="quiz-back-btn">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>Voltar ao Curso</span>
                                </button>
                                <div class="quiz-nav-buttons">
                                    <button class="quiz-btn quiz-btn-outline" id="quiz-prev-btn" style="display: none;">
                                        <i class="fas fa-chevron-left"></i>
                                        <span>Anterior</span>
                                    </button>
                                    <button class="quiz-btn quiz-btn-primary" id="quiz-next-btn">
                                        <span>Próxima</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <button class="quiz-btn quiz-btn-success" id="quiz-submit-btn" style="display: none;">
                                        <i class="fas fa-check"></i>
                                        <span>Finalizar Prova</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Results State -->
                <div class="quiz-results-state" id="quiz-results-state" style="display: none;">
                    <div class="quiz-results-container">
                        <div class="quiz-results-header">
                            <div class="quiz-results-icon" id="quiz-results-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h2 class="quiz-results-title" id="quiz-results-title">Parabéns!</h2>
                            <p class="quiz-results-subtitle" id="quiz-results-subtitle">Você concluiu a prova do módulo</p>
                        </div>

                        <div class="quiz-results-content">
                            <div class="quiz-score-card">
                                <div class="quiz-score-circle">
                                    <div class="quiz-score-text">
                                        <span class="quiz-score-number" id="quiz-score-number">85</span>
                                        <span class="quiz-score-percent">%</span>
                                    </div>
                                </div>
                                <div class="quiz-score-details">
                                    <div class="quiz-score-item">
                                        <span class="quiz-score-label">Questões Corretas:</span>
                                        <span class="quiz-score-value" id="quiz-correct-answers">4 de 5</span>
                                    </div>
                                    <div class="quiz-score-item">
                                        <span class="quiz-score-label">Nota Final:</span>
                                        <span class="quiz-score-value" id="quiz-final-grade">8.5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="quiz-results-actions">
                                <button class="quiz-btn quiz-btn-primary" id="quiz-continue-btn">
                                    <i class="fas fa-arrow-right"></i>
                                    <span>Continuar Estudos</span>
                                </button>
                                <button class="quiz-btn quiz-btn-outline" id="quiz-review-btn">
                                    <i class="fas fa-eye"></i>
                                    <span>Revisar Respostas</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Tab Content: Meus Cursos -->
        <div class="tab-content" id="tab-cursos">
            <div class="coming-soon-container">
                <div class="coming-soon-card">
                    <div class="coming-soon-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h2 class="coming-soon-title">Meus Cursos</h2>
                    <p class="coming-soon-description">
                        Esta funcionalidade estará disponível em breve! Aqui você poderá visualizar todos os seus cursos de forma organizada e acompanhar seu progresso individual.
                    </p>
                    <div class="coming-soon-features">
                        <div class="feature-item">
                            <i class="fas fa-list-ul"></i>
                            <span>Lista Completa de Cursos</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-filter"></i>
                            <span>Filtros Avançados</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-search"></i>
                            <span>Busca Inteligente</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Progresso -->
        <div class="tab-content" id="tab-progresso">
            <div class="coming-soon-container">
                <div class="coming-soon-card">
                    <div class="coming-soon-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2 class="coming-soon-title">Progresso</h2>
                    <p class="coming-soon-description">
                        Em breve você terá acesso a relatórios detalhados do seu progresso! Acompanhe seu desempenho com gráficos e estatísticas completas.
                    </p>
                    <div class="coming-soon-features">
                        <div class="feature-item">
                            <i class="fas fa-chart-bar"></i>
                            <span>Gráficos Detalhados</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-trophy"></i>
                            <span>Conquistas</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-clock"></i>
                            <span>Tempo de Estudo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Certificados -->
        <div class="tab-content" id="tab-certificados">
            <div class="certificates-container">
                <div class="certificates-header">
                    <h2 class="certificates-title">
                        <i class="fas fa-certificate"></i>
                        <span>Meus Certificados</span>
                    </h2>
                    <p class="certificates-description">
                        Aqui você pode emitir e baixar seus certificados de conclusão dos cursos.
                    </p>
                </div>
                
                <div class="certificates-list" id="certificates-list">
                    <!-- Loading state -->
                    <div class="loading-certificates" id="loading-certificates">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Carregando certificados...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Notificações -->
        <div class="tab-content" id="tab-cronograma">
            <div class="notifications-container">
                <div class="notifications-header">
                    <h2 class="notifications-title">
                        <i class="fas fa-bell"></i>
                        <span>Notificações</span>
                    </h2>
                    <p class="notifications-description">
                        Fique por dentro das últimas novidades e comunicados importantes.
                    </p>
                </div>
                
                <div class="notifications-list" id="notifications-list">
                    <!-- Loading state -->
                    <div class="loading-notifications" id="loading-notifications">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Carregando notificações...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Suporte -->
        <div class="tab-content" id="tab-suporte">
            <div class="support-container">
                <div class="support-header">
                    <h2 class="support-title">
                        <i class="fas fa-headset"></i>
                        <span>Canais de Suporte</span>
                    </h2>
                    <p class="support-description">
                        Escolha a melhor forma de entrar em contato conosco para obter ajuda.
                    </p>
                </div>
                
                <div class="support-options">
                    <div class="support-card">
                        <div class="support-card-icon whatsapp">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <h3 class="support-card-title">WhatsApp</h3>
                        <p class="support-card-description">Fale com nossa equipe de suporte via WhatsApp.</p>
                        <div class="whatsapp-buttons" id="whatsapp-buttons">
                            <button class="support-btn whatsapp-btn" data-number="5511912345678">
                                <i class="fab fa-whatsapp"></i>
                                Fale Conosco
                            </button>
                        </div>
                    </div>

                    <div class="support-card">
                        <div class="support-card-icon email">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h3 class="support-card-title">E-mail</h3>
                        <p class="support-card-description">Envie-nos um e-mail e responderemos o mais breve possível.</p>
                        <a href="mailto:suporte@allayprofissoes.com.br" class="support-btn email-btn">
                            <i class="fas fa-paper-plane"></i>
                            Enviar E-mail
                        </a>
                    </div>

                    <div class="support-card">
                        <div class="support-card-icon ai">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3 class="support-card-title">Aylla (IA)</h3>
                        <p class="support-card-description">Nossa inteligência artificial está em treinamento para te ajudar 24/7.</p>
                        <button class="support-btn ai-btn disabled" disabled>
                            <i class="fas fa-hourglass-half"></i>
                            Em Breve
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Políticas e Privacidade -->
        <div class="tab-content" id="tab-politica-privacidade">
            <div class="privacy-policy-container">
                <div class="privacy-policy-header">
                    <h2 class="privacy-policy-title">
                        <i class="fas fa-shield-alt"></i>
                        <span>Política de Privacidade</span>
                    </h2>
                    <p class="privacy-policy-description">
                        Leia nossa política de privacidade para entender como seus dados são coletados e utilizados.
                    </p>
                </div>
                <div class="privacy-policy-content" id="privacy-policy-display">
                    <!-- O conteúdo da política de privacidade será carregado aqui -->
                    <div class="loading-policy" id="loading-policy">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Carregando política de privacidade...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIwBp15jP3iXCxftfwZuFFO6y2qoFYrNA",
            authDomain: "allayproject-a9ccc.firebaseapp.com",
            projectId: "allayproject-a9ccc",
            storageBucket: "allayproject-a9ccc.firebasestorage.app",
            messagingSenderId: "712124423347",
            appId: "1:712124423347:web:557a5d70f9f2a60edde4c6",
            measurementId: "G-R1E8NRN4R6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // ===== VARIÁVEIS GLOBAIS =====
        let player = null;
        let isYouTubeAPIReady = false;
        let currentUser = null;
        let currentCourseId = null;
        let currentPlayingModuleIndex = -1;
        let currentPlayingVideoIndex = -1;
        let currentCourseModules = [];
        let currentTab = 'inicio';
        let pendingVideoUrl = null; // Para armazenar URL de vídeo pendente

        // Quiz variables
        let currentQuizModuleIndex = -1;
        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizStartTime = null;

        // ===== TAB NAVIGATION =====
        async function loadSupportContacts() {
    try {
        const supportDoc = await firestore.collection("settings").doc("support").get();
        const whatsappButtonsContainer = document.getElementById("whatsapp-buttons");
        whatsappButtonsContainer.innerHTML = ""; // Limpa botões anteriores

        if (supportDoc.exists) {
            const data = supportDoc.data();

            if (data.whatsappNumbers && Array.isArray(data.whatsappNumbers) && data.whatsappNumbers.length > 0) {
                const whatsappNumber = data.whatsappNumbers[0]; // Usa o primeiro número
                whatsappButtonsContainer.innerHTML = `
                    <button class="support-btn whatsapp-btn" data-number="${whatsappNumber}" onclick="window.open('https://wa.me/${whatsappNumber}', '_blank')">
                        <i class="fab fa-whatsapp"></i>
                        Fale Conosco
                    </button>
                `;
            } else {
                // Caso não tenha números no Firestore
                whatsappButtonsContainer.innerHTML = `
                    <button class="support-btn whatsapp-btn" data-number="5511912345678" onclick="window.open('https://wa.me/5511912345678', '_blank')">
                        <i class="fab fa-whatsapp"></i>
                        Suporte Geral
                    </button>
                    <button class="support-btn whatsapp-btn" data-number="5511987654321" onclick="window.open('https://wa.me/5511987654321', '_blank')">
                        <i class="fab fa-whatsapp"></i>
                        Financeiro
                    </button>
                    <button class="support-btn whatsapp-btn" data-number="5511999998888" onclick="window.open('https://wa.me/5511999998888', '_blank')">
                        <i class="fab fa-whatsapp"></i>
                        Técnico
                    </button>
                `;
            }

            const emailLink = document.querySelector(".email-btn");
            if (emailLink && data.email) {
                emailLink.href = `mailto:${data.email}`;
            }
        } else {
            console.log("Documento de contatos de suporte não encontrado no Firestore.");
            whatsappButtonsContainer.innerHTML = `
                <button class="support-btn whatsapp-btn" data-number="5511912345678" onclick="window.open('https://wa.me/5511912345678', '_blank')">
                    <i class="fab fa-whatsapp"></i>
                    Suporte Geral
                </button>
                <button class="support-btn whatsapp-btn" data-number="5511987654321" onclick="window.open('https://wa.me/5511987654321', '_blank')">
                    <i class="fab fa-whatsapp"></i>
                    Financeiro
                </button>
                <button class="support-btn whatsapp-btn" data-number="5511999998888" onclick="window.open('https://wa.me/5511999998888', '_blank')">
                    <i class="fab fa-whatsapp"></i>
                    Técnico
                </button>
            `;
            document.querySelector(".email-btn").href = "mailto:suporte@allayprofissoes.com.br";
        }
    } catch (error) {
        console.error("Erro ao carregar contatos de suporte:", error);
        document.getElementById("whatsapp-buttons").innerHTML = `
            <button class="support-btn whatsapp-btn" data-number="5511912345678" onclick="window.open('https://wa.me/5511912345678', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Suporte Geral
            </button>
            <button class="support-btn whatsapp-btn" data-number="5511987654321" onclick="window.open('https://wa.me/5511987654321', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Financeiro
            </button>
            <button class="support-btn whatsapp-btn" data-number="5511999998888" onclick="window.open('https://wa.me/5511999998888', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Técnico
            </button>
        `;
        document.querySelector(".email-btn").href = "mailto:suporte@allayprofissoes.com.br";
    }
}

function switchTab(tabName) {
    // Esconde todos os conteúdos das abas
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostra a aba selecionada
    const selectedTab = document.getElementById(`tab-${tabName}`);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Atualiza o menu
    document.querySelectorAll('.nav-menu-item').forEach(item => {
        item.classList.remove('active');
    });

    const selectedMenuItem = document.querySelector(`[data-tab="${tabName}"]`);
    if (selectedMenuItem) {
        selectedMenuItem.classList.add('active');
    }

    currentTab = tabName;

    // Se for aba de suporte, carrega os contatos
    if (tabName === 'suporte') {
        loadSupportContacts();
    }
    
    // Se for aba de cronograma (notificações), carrega as notificações
    if (tabName === 'cronograma') {
        loadNotifications();
    }

    // Se for aba de política de privacidade, carrega a política
    if (tabName === 'politica-privacidade') {
        loadPrivacyPolicy();
    }
}

// ===== PRIVACY POLICY FUNCTIONS =====
async function loadPrivacyPolicy() {
    const policyDisplay = document.getElementById('privacy-policy-display');
    const loadingPolicy = document.getElementById('loading-policy');

    if (loadingPolicy) {
        loadingPolicy.style.display = 'flex';
    }

    try {
        const docRef = firestore.collection("settings").doc("privacyPolicy");
        const docSnap = await docRef.get();

        if (loadingPolicy) {
            loadingPolicy.style.display = 'none';
        }

        if (docSnap.exists) {
            policyDisplay.innerHTML = marked.parse(docSnap.data().content);
        } else {
            policyDisplay.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #64748b;">
                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; color: #475569;"></i>
                    <p style="font-size: 1.125rem; font-weight: 500;">Nenhuma política de privacidade encontrada.</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">Entre em contato com o suporte para mais informações.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error("Erro ao carregar política de privacidade:", error);
        if (loadingPolicy) {
            loadingPolicy.style.display = 'none';
        }
        policyDisplay.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p style="font-size: 1.125rem; font-weight: 500;">Erro ao carregar política de privacidade</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">Tente novamente mais tarde.</p>
            </div>
        `;
    }
}

// ===== NOTIFICATIONS FUNCTIONS =====
let lastNotificationCheck = localStorage.getItem('lastNotificationCheck') || '0';

async function loadNotifications() {
    try {
        const loadingElement = document.getElementById('loading-notifications');
        const notificationsList = document.getElementById('notifications-list');
        
        if (loadingElement) {
            loadingElement.style.display = 'flex';
        }
        
        const notificationsSnapshot = await firestore.collection('notifications')
            .where('isActive', '==', true)
            .orderBy('publishedAt', 'desc')
            .get();
        
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
        
        if (notificationsSnapshot.empty) {
            notificationsList.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #64748b;">
                    <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 1rem; color: #475569;"></i>
                    <p style="font-size: 1.125rem; font-weight: 500;">Nenhuma notificação disponível</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">Quando houver novidades, elas aparecerão aqui.</p>
                </div>
            `;
            return;
        }
        
        const notifications = [];
        notificationsSnapshot.forEach((doc) => {
            notifications.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        notificationsList.innerHTML = notifications.map(notification => {
            const publishedDate = new Date(notification.publishedAt).toLocaleString('pt-BR');
            const priorityConfig = {
                'normal': { color: '#10b981', icon: 'fas fa-info-circle', label: 'Normal' },
                'importante': { color: '#f59e0b', icon: 'fas fa-exclamation-triangle', label: 'Importante' },
                'urgente': { color: '#ef4444', icon: 'fas fa-exclamation-circle', label: 'Urgente' }
            };
            
            const config = priorityConfig[notification.priority] || priorityConfig['normal'];
            
            return `
                <div class="notification-card" style="
                    background: rgba(30, 41, 59, 0.8);
                    border: 1px solid rgba(59, 130, 246, 0.2);
                    border-radius: 1rem;
                    padding: 1.5rem;
                    margin-bottom: 1.5rem;
                    border-left: 4px solid ${config.color};
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                    transition: all 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3 style="color: #e2e8f0; margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600;">
                                ${notification.title}
                            </h3>
                            <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.875rem; color: #94a3b8;">
                                <span style="
                                    background: ${config.color};
                                    color: white;
                                    padding: 0.25rem 0.75rem;
                                    border-radius: 0.375rem;
                                    font-weight: 600;
                                    text-transform: uppercase;
                                    font-size: 0.75rem;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.25rem;
                                ">
                                    <i class="${config.icon}"></i>
                                    ${config.label}
                                </span>
                                <span><i class="fas fa-calendar"></i> ${publishedDate}</span>
                                <span><i class="fas fa-user"></i> ${notification.publishedBy}</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: #cbd5e1; margin: 0; line-height: 1.6; font-size: 1rem;">
                        ${notification.content}
                    </p>
                </div>
            `;
        }).join('');
        
        // Marca como visualizado quando o usuário abre a aba
        markNotificationsAsViewed();
        
    } catch (error) {
        console.error('Erro ao carregar notificações:', error);
        const notificationsList = document.getElementById('notifications-list');
        if (notificationsList) {
            notificationsList.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.125rem; font-weight: 500;">Erro ao carregar notificações</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">Tente novamente mais tarde.</p>
                </div>
            `;
        }
    }
}

async function checkForNewNotifications() {
    try {
        const notificationsSnapshot = await firestore.collection('notifications')
            .where('isActive', '==', true)
            .where('publishedAt', '>', lastNotificationCheck)
            .get();
        
        if (!notificationsSnapshot.empty) {
            showNotificationBell();
        } else {
            hideNotificationBell();
        }
    } catch (error) {
        console.error('Erro ao verificar novas notificações:', error);
    }
}

function showNotificationBell() {
    const bell = document.getElementById('notification-bell');
    if (bell) {
        bell.style.display = 'inline-block';
    }
}

function hideNotificationBell() {
    const bell = document.getElementById('notification-bell');
    if (bell) {
        bell.style.display = 'none';
    }
}

function markNotificationsAsViewed() {
    lastNotificationCheck = new Date().toISOString();
    localStorage.setItem('lastNotificationCheck', lastNotificationCheck);
    hideNotificationBell();
}


        // ===== YOUTUBE API FUNCTIONS =====
        function onYouTubeIframeAPIReady() {
            isYouTubeAPIReady = true;
            console.log('YouTube API carregada com sucesso');
            
            // Se há um vídeo pendente, carregue-o agora
            if (pendingVideoUrl) {
                loadYouTubeVideo(pendingVideoUrl);
                pendingVideoUrl = null;
            }
        }

        function extractYouTubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/i,
                /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/i,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function loadYouTubeVideo(videoUrl) {
            console.log('Tentando carregar vídeo:', videoUrl);
            
            if (!isYouTubeAPIReady) {
                console.log('API do YouTube ainda não carregada, aguardando...');
                pendingVideoUrl = videoUrl;
                return;
            }

            const videoId = extractYouTubeId(videoUrl);
            
            if (!videoId) {
                console.error('ID do YouTube não encontrado na URL:', videoUrl);
                return;
            }
            
            console.log('Carregando vídeo do YouTube:', videoId);

            try {
                if (player && typeof player.loadVideoById === 'function') {
                    console.log('Carregando novo vídeo no player existente');
                    player.loadVideoById(videoId);
                } else {
                    console.log('Criando novo player do YouTube');
                    player = new YT.Player('player', {
                        videoId: videoId,
                        playerVars: {
                            'autoplay': 1,
                            'rel': 0,
                            'modestbranding': 1,
                            'origin': window.location.origin
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar vídeo do YouTube:', error);
            }
        }

        function onPlayerReady(event) {
            console.log('Player pronto');
            try {
                event.target.playVideo();
            } catch (error) {
                console.error('Erro ao iniciar reprodução:', error);
            }
        }

        function onPlayerStateChange(event) {
            console.log('Estado do player mudou:', event.data);
            if (event.data === YT.PlayerState.ENDED) {
                console.log('Vídeo terminou.');
                markVideoAsWatched();
                setTimeout(() => {
                    navigateToNextVideo();
                }, 1000);
            }
        }

        function onPlayerError(event) {
            console.error('Erro no player do YouTube:', event.data);
        }

        // ===== PROGRESS FUNCTIONS =====
        async function calculateCourseProgress(courseId, userEmail) {
            try {
                const courseDoc = await firestore.collection("courses").doc(courseId).get();
                if (!courseDoc.exists) return 0;

                const courseData = courseDoc.data();
                const modules = courseData.modules || [];
                
                // Contar total de vídeos e provas
                let totalVideos = 0;
                let totalQuizzes = 0;
                
                modules.forEach(module => {
                    if (module.videos && Array.isArray(module.videos)) {
                        totalVideos += module.videos.length;
                    }
                    // Contar prova se o módulo tiver quiz
                    if (module.quiz && module.quiz.questions && module.quiz.questions.length > 0) {
                        totalQuizzes += 1;
                    }
                });

                const totalItems = totalVideos + totalQuizzes;
                if (totalItems === 0) return 0;

                // Buscar progresso do usuário
                const progressDoc = await firestore
                    .collection("userProgress")
                    .doc(userEmail)
                    .collection("courses")
                    .doc(courseId)
                    .get();

                let watchedVideos = 0;
                let completedQuizzes = 0;

                if (progressDoc.exists) {
                    const progressData = progressDoc.data();
                    watchedVideos = (progressData.watchedVideos || []).length;
                }

                // Buscar provas concluídas
                try {
                    const studentDoc = await firestore.collection("students").doc(userEmail).get();
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const quizResults = studentData.quizResults || {};
                        const courseQuizResults = quizResults[courseId] || {};
                        
                        // Contar quantas provas foram concluídas para este curso
                        completedQuizzes = Object.keys(courseQuizResults).length;
                    }
                } catch (error) {
                    console.error("Erro ao buscar resultados de provas:", error);
                }

                const completedItems = watchedVideos + completedQuizzes;
                const percentage = Math.round((completedItems / totalItems) * 100);
                
                console.log(`Progresso calculado: ${completedItems}/${totalItems} (${watchedVideos} vídeos + ${completedQuizzes} provas) = ${percentage}%`);
                
                return percentage;
            } catch (error) {
                console.error("Erro ao calcular progresso:", error);
                return 0;
            }
        }

        async function markVideoAsWatched() {
            if (!currentUser || !currentCourseId || currentPlayingModuleIndex === -1 || currentPlayingVideoIndex === -1) {
                console.log('Condições não atendidas para marcar vídeo como assistido');
                return;
            }

            try {
                const userEmail = currentUser.email;
                const moduleIndex = currentPlayingModuleIndex;
                const videoIndex = currentPlayingVideoIndex;
                const videoId = `${moduleIndex}_${videoIndex}`;

                console.log(`Tentando marcar vídeo ${videoId} como assistido`);

                const progressRef = firestore
                    .collection("userProgress")
                    .doc(userEmail)
                    .collection("courses")
                    .doc(currentCourseId);

                const progressDoc = await progressRef.get();
                let watchedVideos = [];
                
                if (progressDoc.exists) {
                    watchedVideos = progressDoc.data().watchedVideos || [];
                }

                if (!watchedVideos.includes(videoId)) {
                    watchedVideos.push(videoId);
                    
                    await progressRef.set({
                        watchedVideos: watchedVideos,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    console.log(`Vídeo ${videoId} marcado como assistido`);
                    
                    await updateCourseProgressBar(currentCourseId);
                    updateVideoStatus(moduleIndex, videoIndex);
                    
                    // Recarregar módulos para atualizar botões de prova
                    await loadModules(currentCourseModules);
                } else {
                    console.log(`Vídeo ${videoId} já estava marcado como assistido`);
                }
            } catch (error) {
                console.error("Erro ao marcar vídeo como assistido:", error);
            }
        }

        async function updateCourseProgressBar(courseId) {
            if (!currentUser) return;

            try {
                const percentage = await calculateCourseProgress(courseId, currentUser.email);
                const courseItem = document.querySelector(`[data-course-id="${courseId}"]`);
                
                if (courseItem) {
                    const progressBar = courseItem.querySelector('.course-progress-bar');
                    const progressText = courseItem.querySelector('.course-progress-text');
                    
                    if (progressBar && progressText) {
                        progressBar.style.width = `${percentage}%`;
                        progressText.textContent = `${percentage}%`;
                        console.log(`Barra de progresso atualizada para ${percentage}%`);
                    }
                }
            } catch (error) {
                console.error("Erro ao atualizar barra de progresso:", error);
            }
        }

        function updateVideoStatus(moduleIndex, videoIndex) {
            const moduleElement = document.querySelector(`[data-module-index="${moduleIndex}"]`);
            if (moduleElement) {
                const videoItems = moduleElement.querySelectorAll('.video-item');
                if (videoItems[videoIndex]) {
                    const statusIcon = videoItems[videoIndex].querySelector('.video-status i');
                    if (statusIcon) {
                        statusIcon.className = 'fas fa-check-circle';
                        statusIcon.style.color = '#10b981';
                    }
                }
            }
        }

        // ===== COURSE FUNCTIONS =====
        async function loadCourses(userEmail) {
            try {
                const studentDocRef = firestore.collection("students").doc(userEmail);
                const studentDocSnap = await studentDocRef.get();

                if (!studentDocSnap.exists) {
                    console.log("Nenhum documento de estudante encontrado para o e-mail:", userEmail);
                    displayNoCoursesMessage();
                    return;
                }

                const studentData = studentDocSnap.data();
                let assignedCourses = [];
                
                if (studentData.assignedCourses && Array.isArray(studentData.assignedCourses)) {
                    assignedCourses = studentData.assignedCourses;
                } else if (studentData.assignedCourse && studentData.assignedCourse !== "") {
                    assignedCourses = [{ name: studentData.assignedCourse, value: 0, paymentMethod: "", mediaOrigin: "", enrollmentDate: "" }];
                }

                if (assignedCourses.length === 0) {
                    displayNoCoursesMessage();
                    return;
                }

                const coursesList = document.getElementById("courses-list");
                coursesList.innerHTML = "";

                for (const assignedCourse of assignedCourses) {
                    const courseId = typeof assignedCourse === 'string' ? assignedCourse : assignedCourse.name;
                    const courseDocRef = firestore.collection("courses").doc(courseId);
                    const courseDocSnap = await courseDocRef.get();

                    if (courseDocSnap.exists) {
                        const courseData = courseDocSnap.data();
                        const courseName = courseData.name || courseDocSnap.id;
                        
                        const progress = await calculateCourseProgress(courseDocSnap.id, userEmail);
                        
                        const courseItem = document.createElement("div");
                        courseItem.classList.add("course-item");
                        courseItem.dataset.courseId = courseDocSnap.id;

                        courseItem.innerHTML = `
                            <div class="course-icon">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="course-details">
                                <h3 class="course-name">${courseName}</h3>
                                <p class="course-desc">${courseData.description || "Curso disponível"}</p>
                                <div class="course-progress">
                                    <div class="course-progress-info">
                                        <span class="course-progress-label">Progresso:</span>
                                        <span class="course-progress-text">${progress}%</span>
                                    </div>
                                    <div class="course-progress-container">
                                        <div class="course-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="course-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        `;
                        
                        courseItem.addEventListener("click", function() {
                            selectCourse(courseDocSnap.id, courseName);
                        });
                        
                        coursesList.appendChild(courseItem);
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar cursos: ", error);
                alert("Erro ao carregar cursos. Verifique o console para mais detalhes.");
            }
        }

        function displayNoCoursesMessage() {
            const coursesList = document.getElementById("courses-list");
            coursesList.innerHTML = `
                <div class="no-courses">
                    <i class="fas fa-book"></i>
                    <p>Nenhum curso atribuído a você.</p>
                </div>
            `;
        }

        async function selectCourse(courseId, courseName) {
            currentCourseId = courseId;
            
            console.log('Curso selecionado:', courseId, courseName);
            
            const courseItems = document.querySelectorAll(".course-item");
            courseItems.forEach(item => item.classList.remove("active"));
            const selectedCourseItem = document.querySelector(`[data-course-id="${courseId}"]`);
            if (selectedCourseItem) {
                selectedCourseItem.classList.add("active");
            }

            document.getElementById("welcome-state").style.display = "none";
            document.getElementById("loading-state").style.display = "flex";
            document.getElementById("classroom-state").style.display = "none";

            try {
                const courseDocRef = firestore.collection("courses").doc(courseId);
                const courseDocSnap = await courseDocRef.get();

                if (!courseDocSnap.exists) {
                    console.error("Curso não encontrado:", courseId);
                    alert("Curso não encontrado.");
                    return;
                }

                const courseData = courseDocSnap.data();
                console.log('Dados do curso:', courseData);

                document.getElementById("current-course-title").innerHTML = `
                    <i class="fas fa-book"></i>
                    <span>${courseName}</span>
                `;
                document.getElementById("current-course-description").textContent = courseData.description || "Descrição não disponível";

                await loadModules(courseData.modules || []);

                document.getElementById("loading-state").style.display = "none";
                document.getElementById("classroom-state").style.display = "block";

            } catch (error) {
                console.error("Erro ao carregar curso:", error);
                alert("Erro ao carregar curso. Verifique o console para mais detalhes.");
                
                document.getElementById("loading-state").style.display = "none";
                document.getElementById("welcome-state").style.display = "flex";
            }
        }

        async function loadModules(modules) {
            const modulesContainer = document.getElementById("modules-container");
            modulesContainer.innerHTML = "";
            
            currentCourseModules = modules;

            if (!modules || modules.length === 0) {
                modulesContainer.innerHTML = `
                    <div class="no-modules">
                        <i class="fas fa-folder-open"></i>
                        <p>Nenhum módulo disponível para este curso.</p>
                    </div>
                `;
                return;
            }

            let watchedVideos = [];
            let completedQuizzes = {};
            
            if (currentUser && currentCourseId) {
                try {
                    // Buscar vídeos assistidos
                    const progressDoc = await firestore
                        .collection("userProgress")
                        .doc(currentUser.email)
                        .collection("courses")
                        .doc(currentCourseId)
                        .get();
                    
                    if (progressDoc.exists) {
                        watchedVideos = progressDoc.data().watchedVideos || [];
                    }

                    // Buscar provas concluídas
                    const studentDoc = await firestore.collection("students").doc(currentUser.email).get();
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const quizResults = studentData.quizResults || {};
                        completedQuizzes = quizResults[currentCourseId] || {};
                    }
                } catch (error) {
                    console.error("Erro ao buscar progresso:", error);
                }
            }

            modules.forEach((module, moduleIndex) => {
                const moduleElement = document.createElement("div");
                moduleElement.classList.add("module-item");
                moduleElement.dataset.moduleIndex = moduleIndex;

                const videos = module.videos || [];
                const videoCount = videos.length;

                // Check if all videos in this module are watched
                const moduleVideosWatched = videos.every((video, videoIndex) => {
                    const videoId = `${moduleIndex}_${videoIndex}`;
                    return watchedVideos.includes(videoId);
                });

                // Check if quiz is completed for this module
                const quizCompleted = completedQuizzes[`module_${moduleIndex}`] !== undefined;

                // Show quiz button if module has quiz (regardless of video completion for testing)
                const hasQuiz = module.quiz && module.quiz.questions && module.quiz.questions.length > 0;
                
                let quizButton = '';
                if (hasQuiz) {
                    if (quizCompleted) {
                        quizButton = `
                            <div class="module-quiz-section">
                                <button class="module-quiz-btn completed" onclick="startModuleQuiz(${moduleIndex})">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Prova Concluída</span>
                                    <span class="quiz-score">${Math.round(completedQuizzes[`module_${moduleIndex}`].score)}%</span>
                                </button>
                            </div>
                        `;
                    } else if (moduleVideosWatched) {
                        quizButton = `
                            <div class="module-quiz-section">
                                <button class="module-quiz-btn" onclick="startModuleQuiz(${moduleIndex})">
                                    <i class="fas fa-clipboard-check"></i>
                                    <span>Fazer Prova do Módulo</span>
                                </button>
                            </div>
                        `;
                    } else {
                        quizButton = `
                            <div class="module-quiz-section">
                                <button class="module-quiz-btn disabled" disabled>
                                    <i class="fas fa-lock"></i>
                                    <span>Complete todos os vídeos para fazer a prova</span>
                                </button>
                            </div>
                        `;
                    }
                }

                moduleElement.innerHTML = `
                    <div class="module-header" onclick="toggleModule(${moduleIndex})">
                        <div class="module-info">
                            <div class="module-icon">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div>
                                <h4 class="module-title">${module.name || `Módulo ${moduleIndex + 1}`}</h4>
                                <p class="module-count">${videoCount} vídeo${videoCount !== 1 ? 's' : ''}${hasQuiz ? ' + 1 prova' : ''}</p>
                            </div>
                        </div>
                        <div class="module-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="videos-list">
                        ${videos.map((video, videoIndex) => {
                            const videoId = `${moduleIndex}_${videoIndex}`;
                            const isWatched = watchedVideos.includes(videoId);
                            const statusIcon = isWatched ? 'fas fa-check-circle' : 'fas fa-circle';
                            const statusColor = isWatched ? '#10b981' : '#64748b';
                            
                            return `
                                <div class="video-item" onclick="playVideo(${moduleIndex}, ${videoIndex})">
                                    <div class="video-icon">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <div class="video-details">
                                        <h5 class="video-title">${video.title || `Vídeo ${videoIndex + 1}`}</h5>
                                        <p class="video-duration">${video.duration || 'Duração não informada'}</p>
                                    </div>
                                    <div class="video-status">
                                        <i class="${statusIcon}" style="color: ${statusColor}"></i>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${quizButton}
                    </div>
                `;

                modulesContainer.appendChild(moduleElement);
            });
        }

        function toggleModule(moduleIndex) {
            const moduleElement = document.querySelector(`[data-module-index="${moduleIndex}"]`);
            if (moduleElement) {
                moduleElement.classList.toggle("expanded");
            }
        }

        function playVideo(moduleIndex, videoIndex) {
            console.log(`Reproduzindo vídeo: Módulo ${moduleIndex}, Vídeo ${videoIndex}`);
            
            currentPlayingModuleIndex = moduleIndex;
            currentPlayingVideoIndex = videoIndex;

            const module = currentCourseModules[moduleIndex];
            const video = module.videos[videoIndex];

            if (!video || !video.url) {
                console.error("URL do vídeo não encontrada");
                alert("URL do vídeo não encontrada");
                return;
            }

            document.getElementById("video-title-display").textContent = video.title || `Vídeo ${videoIndex + 1}`;
            document.getElementById("video-module-display").textContent = `Módulo: ${module.name || `Módulo ${moduleIndex + 1}`}`;

            document.querySelectorAll(".video-item").forEach(item => item.classList.remove("active"));
            
            const moduleElement = document.querySelector(`[data-module-index="${moduleIndex}"]`);
            if (moduleElement) {
                const videoItems = moduleElement.querySelectorAll('.video-item');
                if (videoItems[videoIndex]) {
                    videoItems[videoIndex].classList.add("active");
                }
            }

            document.getElementById("digital-board").style.display = "block";
            loadYouTubeVideo(video.url);
            updateVideoCounter();
        }

        function updateVideoCounter() {
            if (currentPlayingModuleIndex === -1 || currentPlayingVideoIndex === -1) return;

            let totalVideos = 0;
            let currentVideoNumber = 0;

            for (let i = 0; i < currentCourseModules.length; i++) {
                const moduleVideos = currentCourseModules[i].videos.length;
                totalVideos += moduleVideos;
                
                if (i < currentPlayingModuleIndex) {
                    currentVideoNumber += moduleVideos;
                } else if (i === currentPlayingModuleIndex) {
                    currentVideoNumber += currentPlayingVideoIndex + 1;
                }
            }

            const videoCounterElement = document.getElementById("video-counter");
            if (videoCounterElement) {
                videoCounterElement.textContent = `Vídeo ${currentVideoNumber} de ${totalVideos}`;
            }

            const prevBtn = document.getElementById("prev-video-btn");
            const nextBtn = document.getElementById("next-video-btn");

            if (prevBtn) {
                prevBtn.disabled = currentVideoNumber === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentVideoNumber === totalVideos;
            }
        }

        function navigateToNextVideo() {
            if (currentPlayingModuleIndex === -1 || currentPlayingVideoIndex === -1) {
                console.log("Não há vídeo atual para navegar");
                return;
            }

            let nextModuleIndex = currentPlayingModuleIndex;
            let nextVideoIndex = currentPlayingVideoIndex + 1;

            if (nextVideoIndex >= currentCourseModules[nextModuleIndex].videos.length) {
                nextModuleIndex++;
                nextVideoIndex = 0;
            }

            if (nextModuleIndex >= currentCourseModules.length) {
                console.log("Já está no último vídeo");
                return;
            }

            console.log(`Navegando para próximo vídeo: Módulo ${nextModuleIndex}, Vídeo ${nextVideoIndex}`);
            playVideo(nextModuleIndex, nextVideoIndex);
        }

        function navigateToPreviousVideo() {
            if (currentPlayingModuleIndex === -1 || currentPlayingVideoIndex === -1) {
                console.log("Não há vídeo atual para navegar");
                return;
            }

            let prevModuleIndex = currentPlayingModuleIndex;
            let prevVideoIndex = currentPlayingVideoIndex - 1;

            if (prevVideoIndex < 0) {
                prevModuleIndex--;
                if (prevModuleIndex >= 0) {
                    prevVideoIndex = currentCourseModules[prevModuleIndex].videos.length - 1;
                }
            }

            if (prevModuleIndex < 0) {
                console.log("Já está no primeiro vídeo");
                return;
            }

            console.log(`Navegando para vídeo anterior: Módulo ${prevModuleIndex}, Vídeo ${prevVideoIndex}`);
            playVideo(prevModuleIndex, prevVideoIndex);
        }

        // ===== QUIZ FUNCTIONS =====
        async function startModuleQuiz(moduleIndex) {
            try {
                currentQuizModuleIndex = moduleIndex;
                const module = currentCourseModules[moduleIndex];
                
                console.log('Iniciando prova do módulo:', moduleIndex);
                
                // Load quiz data from Firebase
                const courseDoc = await firestore.collection("courses").doc(currentCourseId).get();
                if (!courseDoc.exists) {
                    throw new Error("Curso não encontrado");
                }
                
                const courseData = courseDoc.data();
                const moduleData = courseData.modules[moduleIndex];
                
                if (!moduleData.quiz || !moduleData.quiz.questions || moduleData.quiz.questions.length === 0) {
                    alert("Nenhuma prova disponível para este módulo.");
                    return;
                }
                
                currentQuizData = moduleData.quiz;
                currentQuestionIndex = 0;
                userAnswers = [];
                quizStartTime = new Date();
                
                // Hide classroom and show quiz
                document.getElementById("classroom-state").style.display = "none";
                document.getElementById("quiz-state").style.display = "block";
                
                // Set quiz title
                document.getElementById("quiz-title").textContent = `Prova - ${module.name || `Módulo ${moduleIndex + 1}`}`;
                document.getElementById("quiz-description").textContent = currentQuizData.description || "Responda todas as questões para concluir o módulo";
                
                // Load first question
                loadQuestion(0);
                
            } catch (error) {
                console.error("Erro ao carregar prova:", error);
                alert("Erro ao carregar prova: " + error.message);
            }
        }

        function loadQuestion(questionIndex) {
            const question = currentQuizData.questions[questionIndex];
            const questionContainer = document.getElementById("question-container");
            
            // Update progress
            const progressText = document.getElementById("quiz-progress-text");
            const progressFill = document.getElementById("quiz-progress-fill");
            const totalQuestions = currentQuizData.questions.length;
            
            progressText.textContent = `Questão ${questionIndex + 1} de ${totalQuestions}`;
            const progressPercent = ((questionIndex + 1) / totalQuestions) * 100;
            progressFill.style.width = `${progressPercent}%`;
            
            // Create question HTML
            questionContainer.innerHTML = `
                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number">Questão ${questionIndex + 1}</span>
                    </div>
                    <div class="question-content">
                        <h3 class="question-text">${question.question}</h3>
                        <div class="question-options">
                            ${question.options.map((option, optionIndex) => `
                                <label class="option-label">
                                    <input type="radio" name="question_${questionIndex}" value="${optionIndex}" class="option-input">
                                    <div class="option-content">
                                        <span class="option-letter">${String.fromCharCode(65 + optionIndex)}</span>
                                        <span class="option-text">${option}</span>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Restore previous answer if exists
            if (userAnswers[questionIndex] !== undefined) {
                const radioInput = questionContainer.querySelector(`input[value="${userAnswers[questionIndex]}"]`);
                if (radioInput) {
                    radioInput.checked = true;
                }
            }
            
            // Update navigation buttons
            updateQuizNavigation();
        }

        function updateQuizNavigation() {
            const prevBtn = document.getElementById("quiz-prev-btn");
            const nextBtn = document.getElementById("quiz-next-btn");
            const submitBtn = document.getElementById("quiz-submit-btn");
            const totalQuestions = currentQuizData.questions.length;
            
            // Show/hide previous button
            if (currentQuestionIndex === 0) {
                prevBtn.style.display = "none";
            } else {
                prevBtn.style.display = "flex";
            }
            
            // Show/hide next/submit buttons
            if (currentQuestionIndex === totalQuestions - 1) {
                nextBtn.style.display = "none";
                submitBtn.style.display = "flex";
            } else {
                nextBtn.style.display = "flex";
                submitBtn.style.display = "none";
            }
        }

        function saveCurrentAnswer() {
            const questionContainer = document.getElementById("question-container");
            const selectedOption = questionContainer.querySelector(`input[name="question_${currentQuestionIndex}"]:checked`);
            
            if (selectedOption) {
                userAnswers[currentQuestionIndex] = parseInt(selectedOption.value);
            }
        }

        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                saveCurrentAnswer();
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
            }
        }

        function goToNextQuestion() {
            const totalQuestions = currentQuizData.questions.length;
            if (currentQuestionIndex < totalQuestions - 1) {
                saveCurrentAnswer();
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
            }
        }

        async function submitQuiz() {
            try {
                // Save current answer
                saveCurrentAnswer();
                
                // Check if all questions are answered
                const totalQuestions = currentQuizData.questions.length;
                if (userAnswers.length !== totalQuestions || userAnswers.some(answer => answer === undefined)) {
                    alert("Por favor, responda todas as questões antes de finalizar a prova.");
                    return;
                }
                
                // Calculate score
                let correctAnswers = 0;
                userAnswers.forEach((answer, index) => {
                    if (answer === currentQuizData.questions[index].correctAnswer) {
                        correctAnswers++;
                    }
                });
                
                const scorePercentage = Math.round((correctAnswers / totalQuestions) * 100);
                const finalGrade = (correctAnswers / totalQuestions) * 10;
                
                // Save quiz result to Firebase
                await saveQuizResult(scorePercentage, correctAnswers, totalQuestions, finalGrade);
                
                // Show results
                showQuizResults(scorePercentage, correctAnswers, totalQuestions, finalGrade);
                
            } catch (error) {
                console.error("Erro ao finalizar prova:", error);
                alert("Erro ao finalizar prova: " + error.message);
            }
        }

        async function saveQuizResult(scorePercentage, correctAnswers, totalQuestions, finalGrade) {
            try {
                const userEmail = currentUser.email;
                const quizEndTime = new Date();
                const timeSpent = Math.round((quizEndTime - quizStartTime) / 1000); // in seconds
                
                const quizResult = {
                    courseId: currentCourseId,
                    moduleIndex: currentQuizModuleIndex,
                    moduleName: currentCourseModules[currentQuizModuleIndex].name || `Módulo ${currentQuizModuleIndex + 1}`,
                    scorePercentage: scorePercentage,
                    correctAnswers: correctAnswers,
                    totalQuestions: totalQuestions,
                    finalGrade: finalGrade,
                    userAnswers: userAnswers,
                    timeSpent: timeSpent,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    startTime: quizStartTime,
                    endTime: quizEndTime
                };
                
                // Save to user's quiz results
                await firestore
                    .collection("userProgress")
                    .doc(userEmail)
                    .collection("quizResults")
                    .add(quizResult);
                
                // Also save to student document for easy access
                const studentRef = firestore.collection("students").doc(userEmail);
                await studentRef.update({
                    [`quizResults.${currentCourseId}.module_${currentQuizModuleIndex}`]: {
                        score: scorePercentage,
                        grade: finalGrade,
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                });
                
                console.log("Resultado da prova salvo com sucesso");
                
                // Update course progress bar after quiz completion
                await updateCourseProgressBar(currentCourseId);
                
            } catch (error) {
                console.error("Erro ao salvar resultado da prova:", error);
                throw error;
            }
        }

        function showQuizResults(scorePercentage, correctAnswers, totalQuestions, finalGrade) {
            // Hide quiz and show results
            document.getElementById("quiz-state").style.display = "none";
            document.getElementById("quiz-results-state").style.display = "block";
            
            // Update results display
            document.getElementById("quiz-score-number").textContent = scorePercentage;
            document.getElementById("quiz-correct-answers").textContent = `${correctAnswers} de ${totalQuestions}`;
            document.getElementById("quiz-final-grade").textContent = finalGrade.toFixed(1);
            
            // Update title and icon based on score
            const resultsIcon = document.getElementById("quiz-results-icon");
            const resultsTitle = document.getElementById("quiz-results-title");
            const resultsSubtitle = document.getElementById("quiz-results-subtitle");
            
            if (scorePercentage >= 70) {
                resultsIcon.innerHTML = '<i class="fas fa-trophy"></i>';
                resultsIcon.className = 'quiz-results-icon success';
                resultsTitle.textContent = "Parabéns!";
                resultsSubtitle.textContent = "Você foi aprovado na prova do módulo";
            } else {
                resultsIcon.innerHTML = '<i class="fas fa-redo"></i>';
                resultsIcon.className = 'quiz-results-icon warning';
                resultsTitle.textContent = "Tente Novamente";
                resultsSubtitle.textContent = "Você precisa de pelo menos 70% para ser aprovado";
            }
        }

        function continueStudies() {
            // Hide results and show classroom
            document.getElementById("quiz-results-state").style.display = "none";
            document.getElementById("classroom-state").style.display = "block";
            
            // Reset quiz variables
            currentQuizModuleIndex = -1;
            currentQuizData = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            quizStartTime = null;
            
            // Reload modules to update quiz button status
            if (currentCourseModules.length > 0) {
                loadModules(currentCourseModules);
            }
        }

        function reviewAnswers() {
            // Hide results and show quiz in review mode
            document.getElementById("quiz-results-state").style.display = "none";
            document.getElementById("quiz-state").style.display = "block";
            
            // Load first question in review mode
            currentQuestionIndex = 0;
            loadQuestionReview(0);
        }

        function loadQuestionReview(questionIndex) {
            const question = currentQuizData.questions[questionIndex];
            const questionContainer = document.getElementById("question-container");
            const userAnswer = userAnswers[questionIndex];
            const correctAnswer = question.correctAnswer;
            
            // Update progress
            const progressText = document.getElementById("quiz-progress-text");
            const progressFill = document.getElementById("quiz-progress-fill");
            const totalQuestions = currentQuizData.questions.length;
            
            progressText.textContent = `Revisão - Questão ${questionIndex + 1} de ${totalQuestions}`;
            const progressPercent = ((questionIndex + 1) / totalQuestions) * 100;
            progressFill.style.width = `${progressPercent}%`;
            
            // Create question HTML with review styling
            questionContainer.innerHTML = `
                <div class="question-card review-mode">
                    <div class="question-header">
                        <span class="question-number">Questão ${questionIndex + 1}</span>
                        <span class="question-result ${userAnswer === correctAnswer ? 'correct' : 'incorrect'}">
                            <i class="fas ${userAnswer === correctAnswer ? 'fa-check' : 'fa-times'}"></i>
                            ${userAnswer === correctAnswer ? 'Correta' : 'Incorreta'}
                        </span>
                    </div>
                    <div class="question-content">
                        <h3 class="question-text">${question.question}</h3>
                        <div class="question-options">
                            ${question.options.map((option, optionIndex) => {
                                let optionClass = 'option-label';
                                if (optionIndex === correctAnswer) {
                                    optionClass += ' correct-answer';
                                } else if (optionIndex === userAnswer && userAnswer !== correctAnswer) {
                                    optionClass += ' wrong-answer';
                                }
                                
                                return `
                                    <label class="${optionClass}">
                                        <input type="radio" name="question_${questionIndex}" value="${optionIndex}" class="option-input" disabled ${optionIndex === userAnswer ? 'checked' : ''}>
                                        <div class="option-content">
                                            <span class="option-letter">${String.fromCharCode(65 + optionIndex)}</span>
                                            <span class="option-text">${option}</span>
                                            ${optionIndex === correctAnswer ? '<i class="fas fa-check option-icon"></i>' : ''}
                                            ${optionIndex === userAnswer && userAnswer !== correctAnswer ? '<i class="fas fa-times option-icon"></i>' : ''}
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Update navigation for review mode
            updateQuizNavigationReview();
        }

        function updateQuizNavigationReview() {
            const prevBtn = document.getElementById("quiz-prev-btn");
            const nextBtn = document.getElementById("quiz-next-btn");
            const submitBtn = document.getElementById("quiz-submit-btn");
            const backBtn = document.getElementById("quiz-back-btn");
            const totalQuestions = currentQuizData.questions.length;
            
            // Show/hide previous button
            if (currentQuestionIndex === 0) {
                prevBtn.style.display = "none";
            } else {
                prevBtn.style.display = "flex";
                prevBtn.onclick = () => {
                    currentQuestionIndex--;
                    loadQuestionReview(currentQuestionIndex);
                };
            }
            
            // Show/hide next button
            if (currentQuestionIndex === totalQuestions - 1) {
                nextBtn.style.display = "none";
                submitBtn.style.display = "flex";
                submitBtn.innerHTML = '<i class="fas fa-arrow-left"></i><span>Voltar aos Resultados</span>';
                submitBtn.onclick = () => {
                    document.getElementById("quiz-state").style.display = "none";
                    document.getElementById("quiz-results-state").style.display = "block";
                };
            } else {
                nextBtn.style.display = "flex";
                nextBtn.onclick = () => {
                    currentQuestionIndex++;
                    loadQuestionReview(currentQuestionIndex);
                };
                submitBtn.style.display = "none";
            }
            
            // Update back button
            backBtn.onclick = () => {
                document.getElementById("quiz-state").style.display = "none";
                document.getElementById("quiz-results-state").style.display = "block";
            };
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, inicializando aplicação...');

            // ===== NAVIGATION MENU FUNCTIONALITY =====
            const navMenuBtn = document.getElementById('nav-menu-btn');
            const navMenu = document.getElementById('nav-menu');
            const navMenuToggle = document.getElementById('nav-menu-toggle');
            const navMenuOverlay = document.getElementById('nav-menu-overlay');
            const navMenuItems = document.querySelectorAll('.nav-menu-item');

            function toggleMenu() {
                navMenu.classList.toggle('active');
                navMenuOverlay.classList.toggle('active');
                document.body.classList.toggle('nav-menu-open');
            }

            function closeMenu() {
                navMenu.classList.remove('active');
                navMenuOverlay.classList.remove('active');
                document.body.classList.remove('nav-menu-open');
            }

            if (navMenuBtn) navMenuBtn.addEventListener('click', toggleMenu);
            if (navMenuToggle) navMenuToggle.addEventListener('click', closeMenu);
            if (navMenuOverlay) navMenuOverlay.addEventListener('click', closeMenu);

            navMenuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        switchTab(tabName);
                    }
                    
                    if (window.innerWidth <= 768) {
                        closeMenu();
                    }
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMenu();
                }
            });

            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    closeMenu();
                }
            });
              }); // <-- esse é o fechamento do DOMContentLoaded

            // ===== VIDEO NAVIGATION BUTTONS =====
            const prevVideoBtn = document.getElementById("prev-video-btn");
            const nextVideoBtn = document.getElementById("next-video-btn");
            const backToCoursesBtn = document.getElementById("back-to-courses");
            const logoutButton = document.getElementById("logout-button");

            if (prevVideoBtn) {
                prevVideoBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("Botão anterior clicado");
                    navigateToPreviousVideo();
                });
            }

            if (nextVideoBtn) {
                nextVideoBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("Botão próximo clicado");
                    navigateToNextVideo();
                });
            }

            if (backToCoursesBtn) {
                backToCoursesBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    document.getElementById("classroom-state").style.display = "none";
                    document.getElementById("welcome-state").style.display = "flex";
                    
                    document.querySelectorAll(".course-item").forEach(item => item.classList.remove("active"));
                    currentCourseId = null;
                    currentPlayingModuleIndex = -1;
                    currentPlayingVideoIndex = -1;
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        localStorage.removeItem("loggedInUserEmail");
                        window.location.href = "login.html";
                    }).catch((error) => {
                        console.error("Erro ao fazer logout:", error);
                    });
                });
            }

            // ===== QUIZ NAVIGATION BUTTONS =====
            const quizBackBtn = document.getElementById("quiz-back-btn");
            const quizPrevBtn = document.getElementById("quiz-prev-btn");
            const quizNextBtn = document.getElementById("quiz-next-btn");
            const quizSubmitBtn = document.getElementById("quiz-submit-btn");
            const quizContinueBtn = document.getElementById("quiz-continue-btn");
            const quizReviewBtn = document.getElementById("quiz-review-btn");

            if (quizBackBtn) {
                quizBackBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    document.getElementById("quiz-state").style.display = "none";
                    document.getElementById("classroom-state").style.display = "block";
                });
            }

            if (quizPrevBtn) {
                quizPrevBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    goToPreviousQuestion();
                });
            }

            if (quizNextBtn) {
                quizNextBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    goToNextQuestion();
                });
            }

            if (quizSubmitBtn) {
                quizSubmitBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    submitQuiz();
                });
            }

            if (quizContinueBtn) {
                quizContinueBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    continueStudies();
                });
            }

            if (quizReviewBtn) {
                quizReviewBtn.addEventListener("click", function(e) {
                    e.preventDefault();
                    reviewAnswers();
                });
            }

            // ===== CERTIFICATE FUNCTIONS =====
        async function loadCertificates(userEmail) {
            try {
                const certificatesList = document.getElementById("certificates-list");
                certificatesList.innerHTML = "";

                const studentDocRef = firestore.collection("students").doc(userEmail);
                const studentDocSnap = await studentDocRef.get();

                if (!studentDocSnap.exists) {
                    displayNoCertificatesMessage();
                    return;
                }

                const studentData = studentDocSnap.data();
                let assignedCourses = [];
                
                if (studentData.assignedCourses && Array.isArray(studentData.assignedCourses)) {
                    assignedCourses = studentData.assignedCourses;
                } else if (studentData.assignedCourse && studentData.assignedCourse !== "") {
                    assignedCourses = [{ name: studentData.assignedCourse, value: 0, paymentMethod: "", mediaOrigin: "", enrollmentDate: "" }];
                }

                if (assignedCourses.length === 0) {
                    displayNoCertificatesMessage();
                    return;
                }

                for (const assignedCourse of assignedCourses) {
                    const courseId = typeof assignedCourse === 'string' ? assignedCourse : assignedCourse.name;
                    const courseDocRef = firestore.collection("courses").doc(courseId);
                    const courseDocSnap = await courseDocRef.get();

                    if (courseDocSnap.exists) {
                        const courseData = courseDocSnap.data();
                        const courseName = courseData.name || courseDocSnap.id;
                        const progress = await calculateCourseProgress(courseDocSnap.id, userEmail);
                        
                        const certificateItem = document.createElement("div");
                        certificateItem.classList.add("certificate-item");
                        certificateItem.dataset.courseId = courseDocSnap.id;
                        
                        const isCompleted = progress === 100;
                        const buttonClass = isCompleted ? "btn-primary" : "btn-disabled";
                        const buttonText = isCompleted ? "Emitir Certificado" : `Progresso: ${progress}%`;
                        const buttonIcon = isCompleted ? "fas fa-download" : "fas fa-clock";
                        
                        certificateItem.innerHTML = `
                            <div class="certificate-icon">
                                <i class="fas fa-certificate"></i>
                            </div>
                            <div class="certificate-details">
                                <h3 class="certificate-course-name">${courseName}</h3>
                                <p class="certificate-description">${courseData.description || "Curso disponível"}</p>
                                <div class="certificate-progress">
                                    <div class="certificate-progress-info">
                                        <span class="certificate-progress-label">Progresso:</span>
                                        <span class="certificate-progress-text">${progress}%</span>
                                    </div>
                                    <div class="certificate-progress-container">
                                        <div class="certificate-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                           <div class="certificate-actions">
  <button class="certificate-btn ${buttonClass}"
          ${isCompleted ? '' : 'disabled'}
          data-course-id="${courseDocSnap.id}">
    <i class="${buttonIcon}"></i>
    <span>${buttonText}</span>
  </button>
</div>
                        `;
                        
                        certificatesList.appendChild(certificateItem);
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar certificados: ", error);
                displayNoCertificatesMessage();
            }
        }

        function displayNoCertificatesMessage() {
            const certificatesList = document.getElementById("certificates-list");
            certificatesList.innerHTML = `
                <div class="no-certificates">
                    <i class="fas fa-certificate"></i>
                    <p>Nenhum curso disponível para certificação.</p>
                </div>
            `;
        }

        document.addEventListener("click", function(event) {
  const btn = event.target.closest(".certificate-btn");

  if (btn && !btn.disabled) {
    const courseId = btn.getAttribute("data-course-id");
    if (courseId) {
      generateCertificate(courseId, event);
    }
  }
});


async function generateCertificate(courseId, event) {
    try {
        if (!currentUser) {
            alert("Usuário não autenticado");
            return;
        }

        // Mostrar loading
        const button = event.target.closest('.certificate-btn');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Gerando...</span>';
        button.disabled = true;

        // Buscar dados do aluno
        const studentDoc = await firestore.collection("students").doc(currentUser.email).get();
        if (!studentDoc.exists) {
            throw new Error("Dados do aluno não encontrados");
        }
        const studentData = studentDoc.data();

        // Buscar dados do curso
        const courseDoc = await firestore.collection("courses").doc(courseId).get();
        if (!courseDoc.exists) {
            throw new Error("Dados do curso não encontrados");
        }
        const courseData = courseDoc.data();

        // Preparar dados para o certificado
        const certificateData = {
            studentName: studentData.name || "Nome não informado",
            studentCPF: studentData.cpf || "CPF não informado",
            courseName: courseData.name || courseId,
            courseHours: courseData.hours || "Não informado",
            startDate: formatDate(studentData.enrollmentDate) || "Data não informada",
            endDate: formatDate(new Date()) || "Data não informada",
            modules: getModulesText(courseData.modules || [])
        };

        // Gerar e baixar o certificado
        await downloadCertificatePDF(certificateData);

        // Restaurar botão
        button.innerHTML = originalContent;
        button.disabled = false;

    } catch (error) {
        console.error("Erro ao gerar certificado:", error);
        alert("Erro ao gerar certificado: " + error.message);

        // Restaurar botão em caso de erro
        const button = event.target.closest('.certificate-btn');
        button.innerHTML = '<i class="fas fa-download"></i> <span>Emitir Certificado</span>';
        button.disabled = false;
    }
}

function formatDate(date) {
    if (!date) return null;

    let dateObj;
    if (typeof date === 'string') {
        dateObj = new Date(date);
    } else if (date.toDate) {
        dateObj = date.toDate();
    } else {
        dateObj = new Date(date);
    }

    if (isNaN(dateObj.getTime())) return null;

    return dateObj.toLocaleDateString('pt-BR');
}

function getModulesText(modules) {
    if (!modules || modules.length === 0) return "Módulos não informados";

    return modules.map(module => module.name || "Módulo sem nome").join(", ");
}

        
async function downloadCertificatePDF(data) {
  try {
    // 1. Busca o template HTML
    const response = await fetch('certificadop.html');
    let certificateHTML = await response.text();

    // 2. Preenche os dados dinâmicos
    certificateHTML = certificateHTML
      .replace(/{{NOME_ALUNO}}/g, data.studentName)
      .replace(/{{CPF_ALUNO}}/g, data.studentCPF)
      .replace(/{{NOME_CURSO}}/g, data.courseName)
      .replace(/{{DATA_INICIO}}/g, data.startDate)
      .replace(/{{DATA_FIM}}/g, data.endDate)
      .replace(/{{CARGA_HORARIA}}/g, data.courseHours)
      .replace(/{{MODULOS_CURSO}}/g, data.modules);

    // 3. Cria um iframe oculto para renderizar o HTML
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.width = '210mm';
    iframe.style.height = '297mm';
    iframe.style.top = '-10000px';
    iframe.style.left = '-10000px';
    document.body.appendChild(iframe);

    const iframeDoc = iframe.contentWindow.document;
    iframeDoc.open();
    iframeDoc.write(certificateHTML);
    iframeDoc.close();

    // 4. Espera o iframe carregar tudo
    iframe.onload = async () => {
      try {
        const iframeBody = iframe.contentWindow.document.body;
        const { jsPDF } = window.jspdf;

        // ===============================================================
        // AQUI ESTÁ A CORREÇÃO: Usamos "window.html2canvas"
        // ===============================================================
        const canvas = await window.html2canvas(iframeBody, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
        });

        const imgData = canvas.toDataURL('image/png');

        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4',
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${data.studentName}-certificado.pdf`);

      } catch (e) {
        console.error("Erro ao capturar a imagem do certificado:", e);
        alert("Não foi possível gerar a imagem do certificado.");
      } finally {
        // Remove o iframe da página, mesmo se der erro
        document.body.removeChild(iframe);
      }
    };
  } catch (error) {
    console.error('Erro ao gerar PDF:', error);
    alert('Não foi possível gerar o certificado. Tente novamente.');
    throw error;
  }
}



try {
    const whatsappButtonsContainer = document.getElementById("whatsapp-buttons");
    whatsappButtonsContainer.innerHTML = ''; // Limpa botões existentes

    if (data.whatsappNumbers && Array.isArray(data.whatsappNumbers)) {
        data.whatsappNumbers.forEach(contact => {
            const button = document.createElement('button');
            button.className = 'support-btn whatsapp-btn';
            button.dataset.number = contact.number;
            button.innerHTML = `<i class="fab fa-whatsapp"></i> ${contact.label}`;
            button.onclick = () => window.open(`https://wa.me/${contact.number}`, '_blank');
            whatsappButtonsContainer.appendChild(button);
        });
    } else {
        // Fallback se não tiver números válidos no Firestore
        whatsappButtonsContainer.innerHTML = `
            <button class="support-btn whatsapp-btn" data-number="5511912345678" onclick="window.open('https://wa.me/5511912345678', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Suporte Geral
            </button>
            <button class="support-btn whatsapp-btn" data-number="5511987654321" onclick="window.open('https://wa.me/5511987654321', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Financeiro
            </button>
            <button class="support-btn whatsapp-btn" data-number="5511999998888" onclick="window.open('https://wa.me/5511999998888', '_blank')">
                <i class="fab fa-whatsapp"></i>
                Técnico
            </button>
        `;
    }

    const emailLink = document.querySelector('.email-btn');
    if (emailLink && data.email) {
        emailLink.href = `mailto:${data.email}`;
    } else {
        document.querySelector('.email-btn').href = 'mailto:suporte@allayprofissoes.com.br';
    }

} catch (error) {
    console.error("Erro ao carregar contatos de suporte:", error);

    // Fallback em caso de erro
    document.getElementById("whatsapp-buttons").innerHTML = `
        <button class="support-btn whatsapp-btn" data-number="5511912345678" onclick="window.open('https://wa.me/5511912345678', '_blank')">
            <i class="fab fa-whatsapp"></i>
            Suporte Geral
        </button>
        <button class="support-btn whatsapp-btn" data-number="5511987654321" onclick="window.open('https://wa.me/5511987654321', '_blank')">
            <i class="fab fa-whatsapp"></i>
            Financeiro
        </button>
        <button class="support-btn whatsapp-btn" data-number="5511999998888" onclick="window.open('https://wa.me/5511999998888', '_blank')">
            <i class="fab fa-whatsapp"></i>
            Técnico
        </button>
    `;
    document.querySelector('.email-btn').href = 'mailto:suporte@allayprofissoes.com.br';
}

        // ===== FIREBASE AUTH =====
           document.addEventListener('DOMContentLoaded', () => {
    // ===== FIREBASE AUTH =====
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log("Usuário autenticado:", user.email);

            const db = firebase.firestore();
            db.collection("students")
              .where("email", "==", user.email)
              .get()
              .then((querySnapshot) => {
                const welcomeText = document.getElementById("welcome-text");
                const navMenuUserName = document.getElementById('nav-menu-user-name');
                
                if (!querySnapshot.empty) {
                  querySnapshot.forEach((doc) => {
                    const nome = doc.data().name;
                    if (welcomeText) welcomeText.textContent = ` ${nome}!`;
                    if (navMenuUserName) navMenuUserName.textContent = nome;
                  });
                } else {
                  if (navMenuUserName) navMenuUserName.textContent = user.email;
                }
              })
              .catch((error) => {
                console.error("Erro ao buscar nome no Firestore:", error);
                const navMenuUserName = document.getElementById('nav-menu-user-name');
                if (navMenuUserName) navMenuUserName.textContent = user.email;
              });

            loadCourses(user.email);
            loadCertificates(user.email);
            
            // Inicializar verificação de notificações
            checkForNewNotifications();
            setInterval(checkForNewNotifications, 30000); // Verifica a cada 30 segundos
            
            // Load support contacts on initial load if support tab is active
            if (currentTab === 'suporte') {
                loadSupportContacts();
            }
        } else {
            console.log("Usuário não autenticado");
            window.location.href = "login.html";
        }
    });
});


        // Carrega o script da API do YouTube
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>
</body>
</html>
